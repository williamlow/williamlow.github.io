<!DOCTYPE html>
<html lang="en">
<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Nigeria ABM simulation</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>


	<script src="files/routes_detailed_walk_joined_v3.js"></script>
	<script src="files/locs_v1.js"></script>

	<style>
html, body {
			height: 100%;
			margin: 0;
			background-color: black;
		}
#map {
			height: 800px;
			width: 1200px;
			max-width: 100%;
			max-height: 100%;
			margin: 30px auto;
		}
		
#titleBox p{
color: #cfcfcf;
font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
font-size: 1.25rem;
line-height: 1;
text-align: center;
}

.info {
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}

.readout {
	min-height: 150px;
	min-width: 300px;
	text-align: center;
}

.readout h5 {
    color: black;
	font-size: 25px;
	margin: 15px;
}

.readout span {
display: inline-block;
margin-top: 60px;
font-size: 20px;
}


.legend h4 {
    margin: 0 0 5px;
    color: black;
}

.legend {
    line-height: 18px;
    color: #555;
}
.legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
}

#toggleButton {
  position: absolute;
  top: 20px;
  right: 20px;
  padding: 5px;
  z-index: 500;
}

.leaflet-tooltip{
background-color: transparent;
border: 0px;
box-shadow: none;
}

.leaflet-tooltip-bottom::before {
  border-bottom-color: transparent;
}

.locLabel{
    color: white;
   text-shadow:
    -1px -1px 0 #000,
     0   -1px 0 #000,
     1px -1px 0 #000,
     1px  0   0 #000,
     1px  1px 0 #000,
     0    1px 0 #000,
    -1px  1px 0 #000,
    -1px  0   0 #000;
}

	</style>

	
</head>
<body>



<div id="map" style="width: 1200px; height: 800px;">
<button id="toggleButton" onclick="toggleSimple()">
        Toggle simple routes
</button>
	  </div>
<div id="titleBox">
<p>Nigeria displacement</p>
<p>100 day simulation</p>
<p>14/06/2019 &#8211; 22/09/2019</p>
</div>
<script>

	const map = L.map('map').setView([9.97967,9.06372], 7);

	<!-- const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { -->
		<!-- maxZoom: 19, -->
		<!-- attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' -->
	<!-- }).addTo(map); -->

<!-- var CartoDB_Positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { -->
	<!-- attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>', -->
	<!-- subdomains: 'abcd', -->
	<!-- maxZoom: 20 -->
<!-- }).addTo(map); -->

    const accessToken = 'U6QI4wv2b3SRlAE7AMATOVUAAQ9Ne7kXT5nVZdJy4R0nWMiG7Do0yw3Jpsxhsv5N';
	
    L.tileLayer(
      `https://tile.jawg.io/jawg-dark/{z}/{x}/{y}.png?access-token=${accessToken}`, {
        attribution: '<a href="http://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank" class="jawg-attrib">&copy; <b>Jawg</b>Maps</a> | <a href="https://www.openstreetmap.org/copyright" title="OpenStreetMap is open data licensed under ODbL" target="_blank" class="osm-attrib">&copy; OSM contributors</a>',
        maxZoom: 22
      }
    ).addTo(map);

//style for points

////scale  for colour
function locColor(d) {
    return d > 60000   ? '#a50f15' :
           d > 30000   ? '#de2d26' :
           d > 15000   ? '#fb6a4a' :
           d > 5000   ? '#fc9272' :
           d > 1000   ? '#fcbba1' :
                      '#fee5d9';
}

////scale for radius
function locRadius(d) {
    return d > 60000 ? 50 :
           d > 30000   ? 20 :
           d > 15000   ? 15 :
           d > 5000   ? 10 :
           d > 1000   ? 6 :
                      4;
}

////called by circlemarker when locs added to map
function locs_style(feature) {
	return {
    radius: locRadius(feature.properties.agents_at_end),
    fillColor: locColor(feature.properties.agents_at_end),
    color: "#000",
    weight: 0,
    opacity: 1,
    fillOpacity: 0.9
};
}


//style for lines

////scale for colour
function lineColor(d) {
    return d > 15000  ? '#08519c' :
           d > 6000   ? '#3182bd' :
           d > 3500   ? '#6baed6' :
           d > 1500   ? '#bdd7e7' :
                      '#eff3ff';
}

////scale for width
function linewidth(d) {
    return d > 15000  ? 10 :
           d > 6000  ? 9 :
           d > 3500   ? 6 :
           d > 1500   ? 4 :
                      2;
}

////called by style when links added to map
function links_style(feature) {
    return {
        fillColor: '#800026',
        weight: linewidth(feature.properties.agents_total),
        opacity: 1,
        color: lineColor(feature.properties.agents_total),
//        dashArray: '3',
        fillOpacity: 1
    };
}


//location interaction

////called by mouseover locs
function highlightLoc(e) {
    var layer = e.target;
	
    layer.setStyle({
        weight: 5,
        color: '#ceb806',
    });

    //layer.bringToFront();
	
	////sends props to info box
	info.updateLoc(layer.feature.properties);
}


////reset style when mouseout
function resetLoc(e) {
    locs_gj.resetStyle(e.target);
	info.updateLoc();
}

////custom version of oneachfeature as call different functions for locs and links, adds listeners for interactions
function onEachLoc(feature, layer) {
    layer.on({
        mouseover: highlightLoc,
        mouseout: resetLoc,
    });
	////adding text labels
	layer.bindTooltip(
    feature.properties.full_name,
    {
        permanent:true,
        direction:'bottom',
        className: 'locLabel'
    }
);
}


//link interaction

function highlightLink(e) {
    var layer = e.target;

    layer.setStyle({
        color: '#ceb806',
    });
    //layer.bringToFront();
	info.updateLink(layer.feature.properties);
}

function resetLink(e) {
    links_gj.resetStyle(e.target);
	info.updateLink();
}

function onEachLink(feature, layer) {
    layer.on({
        mouseover: highlightLink,
        mouseout: resetLink,
    });
}

//set inital value for smoothing
var smoothFactor = 1;

//function for toggling simple routes
//removes link layer, alters smoothFactor value, respawns links
//could make more efficient with function to spawn links_gj, passing smoothFactor as argument
//would need to define links_gj outside function first so it persists outside it
function toggleSimple() {
if (smoothFactor == 1) {
map.removeLayer(links_gj);
smoothFactor = 50;

links_gj = L.geoJSON(links, {
	smoothFactor: smoothFactor,
	onEachFeature: onEachLink,
	style: function (feature) {
	return links_style(feature)}}
	).addTo(map);
//spawns at front, so send back
links_gj.bringToBack();

} else {
map.removeLayer(links_gj);
smoothFactor = 1;

links_gj = L.geoJSON(links, {
	smoothFactor: smoothFactor,
	onEachFeature: onEachLink,
	style: function (feature) {
	return links_style(feature)}}
	).addTo(map);

links_gj.bringToBack();
}}


//add links and locs to map

////changed to var as remove and respawn due to simple routes toggle - check if neccesary
var links_gj = L.geoJSON(links, {
	smoothFactor: smoothFactor,
	onEachFeature: onEachLink,
	style: function (feature) {
	return links_style(feature)}}
	).addTo(map);
	
	
const locs_gj = L.geoJSON(locs, {
	onEachFeature: onEachLoc,
    pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, locs_style(feature));
    }}
	).addTo(map);


//info box

var info = L.control({position: 'bottomright'});

info.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'info readout'); // create a div with a class "info"
    this.updateLoc();
    return this._div;
};

////function to update the control based on feature properties passed
////seperate functions for links and locs, but both reset to same
////could make single function that checks whether link or loc is calling it
////.toLocaleString() gives number formatting
info.updateLoc = function (props) {
    this._div.innerHTML = (props ?
        '<h5>' + props.full_name + '</h5><p><b>' + props.agents_at_end.toLocaleString() + '</b> agents at the end of the simulation</p>' +
		'<img src="webmap_inputs/' + props.graph + '">' 
        : '<span>Hover over a location or route</span>');
};

info.updateLink = function (props) {
    this._div.innerHTML = (props ?
        '<h5>' + props.full_name + '</h5><p><b>' + props.agents_total.toLocaleString() + '</b> agents used this route during the simulation</p>' +
				'<img src="webmap_inputs/' + props.graph + '">' 
        : '<span>Hover over a location or route</span>');
};

info.addTo(map);

//legends
//taken from leaflet chloro example


////locations

var legend_locs = L.control({position: 'bottomleft'});

legend_locs.onAdd = function (map) {

    var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 1000, 5000, 15000, 30000, 60000],
        labels = [];

	div.innerHTML = '<h4>Agents at locations</h4>';
    // loop through our intervals and generate a label with a colored square for each interval
	// added .toLocaleString() to give formatted numbers
    
	for (var i = 0; i < grades.length; i++) {
        div.innerHTML +=
            '<i style="background:' + locColor(grades[i] + 1) + '"></i> ' +
            grades[i].toLocaleString() + (grades[i + 1] ? '&ndash;' + grades[i + 1].toLocaleString() + '<br>' : '+');
    }

    return div;
};

legend_locs.addTo(map);


///Links

var legend_links = L.control({position: 'bottomleft'});

legend_links.onAdd = function (map) {

    var div = L.DomUtil.create('div', 'info legend'),
        grades = [0, 1500, 3500, 6000, 15000],
        labels = [];

	div.innerHTML = '<h4>Agents on routes</h4>';
    // loop through our density intervals and generate a label with a colored square for each interval
    
	for (var i = 0; i < grades.length; i++) {
        div.innerHTML +=
            '<i style="background:' + lineColor(grades[i] + 1) + '"></i> ' +
            grades[i].toLocaleString() + (grades[i + 1] ? '&ndash;' + grades[i + 1].toLocaleString() + '<br>' : '+');
    }

    return div;
};

legend_links.addTo(map);

</script>

</body>
</html>







